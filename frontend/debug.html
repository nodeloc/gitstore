<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•å·¥å…· - GitStore</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
        }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #569cd6;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .info-item {
            margin: 10px 0;
            padding: 10px;
            background: #1e1e1e;
            border-left: 3px solid #4ec9b0;
        }
        .label {
            color: #9cdcfe;
            font-weight: bold;
        }
        .value {
            color: #ce9178;
            word-break: break-all;
        }
        .success {
            border-left-color: #4ec9b0;
        }
        .error {
            border-left-color: #f48771;
        }
        .warning {
            border-left-color: #dcdcaa;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background: #1177bb;
        }
        .btn-danger {
            background: #a1260d;
        }
        .btn-danger:hover {
            background: #c72e0f;
        }
        .btn-success {
            background: #107c10;
        }
        .btn-success:hover {
            background: #13a313;
        }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            color: #d4d4d4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ GitStore è°ƒè¯•å·¥å…·</h1>
        
        <div class="section">
            <h2>ğŸ“¦ LocalStorage çŠ¶æ€</h2>
            <div id="localStorageStatus"></div>
            <button onclick="checkLocalStorage()">åˆ·æ–°æ£€æŸ¥</button>
            <button class="btn-danger" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>

        <div class="section">
            <h2>ğŸ”‘ Token ä¿¡æ¯</h2>
            <div id="tokenInfo"></div>
            <button onclick="decodeToken()">è§£ç Token</button>
        </div>

        <div class="section">
            <h2>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</h2>
            <div id="userInfo"></div>
        </div>

        <div class="section">
            <h2>ğŸ§ª API æµ‹è¯•</h2>
            <button onclick="testAuthMe()">æµ‹è¯• /api/auth/me</button>
            <button onclick="testAdminPlugins()">æµ‹è¯• /api/admin/plugins</button>
            <div id="apiTest" style="margin-top: 15px;"></div>
        </div>

        <div class="section">
            <h2>ğŸš€ å¿«æ·æ“ä½œ</h2>
            <button class="btn-success" onclick="devLogin()">å¼€å‘ç™»å½•</button>
            <button onclick="goToAdmin()">è·³è½¬åˆ°ç®¡ç†åå°</button>
            <button onclick="goToHome()">è·³è½¬åˆ°é¦–é¡µ</button>
        </div>
    </div>

    <script>
        function showInfo(containerId, html) {
            document.getElementById(containerId).innerHTML = html;
        }

        function checkLocalStorage() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            let html = '';
            
            if (token) {
                html += `<div class="info-item success">
                    <div class="label">âœ… Token:</div>
                    <div class="value">${token.substring(0, 50)}...</div>
                </div>`;
            } else {
                html += `<div class="info-item error">
                    <div class="label">âŒ Token:</div>
                    <div class="value">æœªæ‰¾åˆ°</div>
                </div>`;
            }
            
            if (user) {
                html += `<div class="info-item success">
                    <div class="label">âœ… User:</div>
                    <div class="value">${user}</div>
                </div>`;
            } else {
                html += `<div class="info-item error">
                    <div class="label">âŒ User:</div>
                    <div class="value">æœªæ‰¾åˆ°</div>
                </div>`;
            }
            
            showInfo('localStorageStatus', html);
            checkUser();
            decodeToken();
        }

        function checkUser() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                showInfo('userInfo', '<div class="info-item error">æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯</div>');
                return;
            }
            
            try {
                const user = JSON.parse(userStr);
                const html = `
                    <div class="info-item success">
                        <div class="label">ID:</div>
                        <div class="value">${user.id || 'N/A'}</div>
                    </div>
                    <div class="info-item success">
                        <div class="label">Email:</div>
                        <div class="value">${user.email || 'N/A'}</div>
                    </div>
                    <div class="info-item success">
                        <div class="label">Name:</div>
                        <div class="value">${user.name || 'N/A'}</div>
                    </div>
                    <div class="info-item ${user.role === 'admin' ? 'success' : 'warning'}">
                        <div class="label">Role:</div>
                        <div class="value">${user.role || 'N/A'}</div>
                    </div>
                `;
                showInfo('userInfo', html);
            } catch (e) {
                showInfo('userInfo', `<div class="info-item error">è§£æå¤±è´¥: ${e.message}</div>`);
            }
        }

        function decodeToken() {
            const token = localStorage.getItem('token');
            if (!token) {
                showInfo('tokenInfo', '<div class="info-item error">æœªæ‰¾åˆ°Token</div>');
                return;
            }
            
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Tokenæ ¼å¼é”™è¯¯');
                }
                
                const payload = JSON.parse(atob(parts[1]));
                const exp = new Date(payload.exp * 1000);
                const iat = new Date(payload.iat * 1000);
                const now = new Date();
                const isExpired = now > exp;
                
                const html = `
                    <div class="info-item ${isExpired ? 'error' : 'success'}">
                        <div class="label">çŠ¶æ€:</div>
                        <div class="value">${isExpired ? 'âŒ å·²è¿‡æœŸ' : 'âœ… æœ‰æ•ˆ'}</div>
                    </div>
                    <div class="info-item">
                        <div class="label">ç”¨æˆ·ID:</div>
                        <div class="value">${payload.user_id}</div>
                    </div>
                    <div class="info-item">
                        <div class="label">é‚®ç®±:</div>
                        <div class="value">${payload.email}</div>
                    </div>
                    <div class="info-item">
                        <div class="label">è§’è‰²:</div>
                        <div class="value">${payload.role}</div>
                    </div>
                    <div class="info-item">
                        <div class="label">ç­¾å‘æ—¶é—´:</div>
                        <div class="value">${iat.toLocaleString()}</div>
                    </div>
                    <div class="info-item">
                        <div class="label">è¿‡æœŸæ—¶é—´:</div>
                        <div class="value">${exp.toLocaleString()}</div>
                    </div>
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #569cd6;">æŸ¥çœ‹å®Œæ•´Payload</summary>
                        <pre>${JSON.stringify(payload, null, 2)}</pre>
                    </details>
                `;
                showInfo('tokenInfo', html);
            } catch (e) {
                showInfo('tokenInfo', `<div class="info-item error">è§£ç å¤±è´¥: ${e.message}</div>`);
            }
        }

        async function testAuthMe() {
            const token = localStorage.getItem('token');
            if (!token) {
                showInfo('apiTest', '<div class="info-item error">è¯·å…ˆç™»å½•</div>');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8080/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                showInfo('apiTest', `
                    <div class="info-item ${response.ok ? 'success' : 'error'}">
                        <div class="label">çŠ¶æ€ç : ${response.status}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `);
            } catch (e) {
                showInfo('apiTest', `<div class="info-item error">è¯·æ±‚å¤±è´¥: ${e.message}</div>`);
            }
        }

        async function testAdminPlugins() {
            const token = localStorage.getItem('token');
            if (!token) {
                showInfo('apiTest', '<div class="info-item error">è¯·å…ˆç™»å½•</div>');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8080/api/admin/plugins', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                showInfo('apiTest', `
                    <div class="info-item ${response.ok ? 'success' : 'error'}">
                        <div class="label">çŠ¶æ€ç : ${response.status}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `);
            } catch (e) {
                showInfo('apiTest', `<div class="info-item error">è¯·æ±‚å¤±è´¥: ${e.message}</div>`);
            }
        }

        async function devLogin() {
            try {
                const response = await fetch('http://localhost:8080/api/dev/login?email=admin@test.com');
                const data = await response.json();
                
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    alert('âœ… ç™»å½•æˆåŠŸï¼');
                    checkLocalStorage();
                } else {
                    alert('âŒ ç™»å½•å¤±è´¥');
                }
            } catch (e) {
                alert('âŒ è¯·æ±‚å¤±è´¥: ' + e.message);
            }
        }

        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                alert('âœ… å·²æ¸…ç©º');
                checkLocalStorage();
            }
        }

        function goToAdmin() {
            window.location.href = 'http://localhost:3002/admin';
        }

        function goToHome() {
            window.location.href = 'http://localhost:3002/';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = checkLocalStorage;
    </script>
</body>
</html>
